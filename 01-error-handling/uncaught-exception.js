// ============================================
// íŒŒì¼ëª…: server.js
// ì‹¤í–‰: node server.js
// ============================================
// 3ê°€ì§€ APIë¥¼ ë§Œë“¤ì–´ì„œ ë¹„êµí•©ë‹ˆë‹¤:
//   /crash    â†’ ì„œë²„ê°€ ì£½ìŒ (uncaughtException)
//   /safe     â†’ ì—ëŸ¬ê°€ ë‚˜ì§€ë§Œ ì„œë²„ ì•ˆ ì£½ìŒ (try-catch)
//   /health   â†’ ì„œë²„ê°€ ì‚´ì•„ìˆëŠ”ì§€ í™•ì¸ìš©

const http = require('http');

// â”€â”€â”€ ëª¨ë“  ìš”ì²­ì´ ê³µìœ í•˜ëŠ” ìƒíƒœ (ëª¨ë“ˆ ìŠ¤ì½”í”„) â”€â”€â”€
let cache = {
  users: ['ê¹€ì¤€í˜¸', 'ì´ì˜í¬', 'ë°•ì² ìˆ˜'],
  ready: true
};

const server = http.createServer((req, res) => {
  res.setHeader('Content-Type', 'application/json; charset=utf-8');

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API 1: /crash â€” ì„œë²„ê°€ ì£½ëŠ” ì¼€ì´ìŠ¤
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (req.url === '/crash') {
    console.log('\nğŸ”´ /crash í˜¸ì¶œë¨');
    console.log('   â†’ setTimeout ì•ˆì—ì„œ ì—ëŸ¬ë¥¼ throwí•©ë‹ˆë‹¤');
    console.log('   â†’ try-catchê°€ ì—†ìœ¼ë¯€ë¡œ uncaughtException ë°œìƒ');
    console.log('   â†’ ì„œë²„ê°€ ì£½ìŠµë‹ˆë‹¤\n');

    res.end(JSON.stringify({
      message: '1ì´ˆ í›„ì— ì„œë²„ê°€ ì£½ìŠµë‹ˆë‹¤. /healthë¡œ í™•ì¸í•´ë³´ì„¸ìš”.'
    }));

    // setTimeout ì½œë°± ì•ˆì˜ ì—ëŸ¬ â†’ ì•„ë¬´ë„ ì•ˆ ì¡ìŒ â†’ ì„œë²„ ì£½ìŒ
    setTimeout(() => {
      console.log('   cache ìƒíƒœ ë³€ê²½ ì‹œì‘...');
      cache.users = null;          // ì—¬ê¸°ê¹Œì§€ ì‹¤í–‰ë¨
      cache.ready = false;         // ì—¬ê¸°ê¹Œì§€ ì‹¤í–‰ë¨
      throw new Error('ğŸ’¥ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ ë°œìƒ!');
      cache.users = ['ìƒˆ ë°ì´í„°']; // ì‹¤í–‰ ì•ˆ ë¨
      cache.ready = true;          // ì‹¤í–‰ ì•ˆ ë¨
    }, 1000);

    return;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API 2: /safe â€” ì„œë²„ê°€ ì•ˆ ì£½ëŠ” ì¼€ì´ìŠ¤
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (req.url === '/safe') {
    console.log('\nğŸŸ¢ /safe í˜¸ì¶œë¨');
    console.log('   â†’ setTimeout ì•ˆì—ì„œ ì—ëŸ¬ê°€ ë‚˜ì§€ë§Œ try-catchë¡œ ì¡ìŒ');
    console.log('   â†’ ì„œë²„ ì•ˆ ì£½ìŒ\n');

    res.end(JSON.stringify({
      message: '1ì´ˆ í›„ì— ì—ëŸ¬ê°€ ë‚˜ì§€ë§Œ ì¡í™ë‹ˆë‹¤. /healthë¡œ í™•ì¸í•´ë³´ì„¸ìš”.'
    }));

    setTimeout(() => {
      try {
        console.log('   cache ìƒíƒœ ë³€ê²½ ì‹œì‘...');
        cache.users = null;
        throw new Error('ğŸ’¥ ì—ëŸ¬ ë°œìƒ! í•˜ì§€ë§Œ ì¡í˜');
        cache.users = ['ìƒˆ ë°ì´í„°'];
      } catch (e) {
        console.log('   âœ… catchì—ì„œ ì¡ìŒ:', e.message);
        console.log('   âœ… cache ìƒíƒœ ë³µêµ¬ ì¤‘...');
        cache.users = ['ê¹€ì¤€í˜¸', 'ì´ì˜í¬', 'ë°•ì² ìˆ˜']; // ë³µêµ¬
        cache.ready = true;
        console.log('   âœ… ë³µêµ¬ ì™„ë£Œ. ì„œë²„ ì •ìƒ ë™ì‘ ì¤‘\n');
      }
    }, 1000);

    return;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API 3: /health â€” ì„œë²„ ìƒíƒœ í™•ì¸
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (req.url === '/health') {
    console.log('ğŸ’š /health í˜¸ì¶œë¨ â€” ì„œë²„ ì‚´ì•„ìˆìŒ');

    res.end(JSON.stringify({
      status: 'alive',
      cache: cache,
      pid: process.pid,
      uptime: Math.round(process.uptime()) + 'ì´ˆ'
    }, null, 2));

    return;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê¸°ë³¸: ì‚¬ìš©ë²• ì•ˆë‚´
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  res.end(JSON.stringify({
    guide: {
      '1ë‹¨ê³„': 'GET /health â†’ ì„œë²„ ìƒíƒœ í™•ì¸',
      '2ë‹¨ê³„': 'GET /safe â†’ ì—ëŸ¬ ë°œìƒí•˜ì§€ë§Œ ì„œë²„ ì•ˆ ì£½ìŒ',
      '3ë‹¨ê³„': 'GET /health â†’ ì„œë²„ ì—¬ì „íˆ ì‚´ì•„ìˆìŒ',
      '4ë‹¨ê³„': 'GET /crash â†’ ì„œë²„ê°€ ì£½ìŒ',
      '5ë‹¨ê³„': 'GET /health â†’ ì—°ê²° ê±°ë¶€ë¨ (ì„œë²„ ì£½ì—ˆìœ¼ë¯€ë¡œ)',
    }
  }, null, 2));
});

// â”€â”€â”€ ì „ì—­ ì•ˆì „ë§ (ì£¼ì„ í•´ì œí•˜ë©´ /crashì—ì„œë„ ì•ˆ ì£½ìŒ) â”€â”€â”€
// ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ë©´ uncaughtExceptionì„ ì¡ì•„ì„œ ì„œë²„ê°€ ì•ˆ ì£½ìŠµë‹ˆë‹¤.
// ë¨¼ì € ì£¼ì„ ìƒíƒœë¡œ /crashë¥¼ í…ŒìŠ¤íŠ¸í•˜ê³ ,
// ê·¸ ë‹¤ìŒ ì£¼ì„ì„ í’€ê³  /crashë¥¼ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.

process.on('uncaughtException', (err) => {
  console.log('ğŸ›¡ï¸ uncaughtException ì¡í˜!');
  console.log('   ì—ëŸ¬:', err.message);
  console.log('   â†’ ë¡œê·¸ ë‚¨ê¸°ê³  ì„œë²„ëŠ” ê³„ì† ë™ì‘');
  console.log('   â†’ í•˜ì§€ë§Œ cache ìƒíƒœê°€ ì˜¤ì—¼ë˜ì—ˆì„ ìˆ˜ ìˆìŒ');
  console.log('   â†’ cache í˜„ì¬ ìƒíƒœ:', JSON.stringify(cache));
  console.log('   â†’ ì‹¤ë¬´ì—ì„œëŠ” ë¡œê·¸ ë‚¨ê¸°ê³  process.exit(1) ê¶Œì¥\n');
});

server.listen(3000, () => {
  console.log('============================================');
  console.log(' uncaughtException ë°ëª¨ ì„œë²„');
  console.log(' http://localhost:3000');
  console.log('============================================');
  console.log('');
  console.log(' í…ŒìŠ¤íŠ¸ ìˆœì„œ:');
  console.log(' 1. curl http://localhost:3000/health');
  console.log(' 2. curl http://localhost:3000/safe');
  console.log(' 3. curl http://localhost:3000/health  â† ì‚´ì•„ìˆìŒ');
  console.log(' 4. curl http://localhost:3000/crash');
  console.log(' 5. curl http://localhost:3000/health  â† ì—°ê²° ê±°ë¶€');
  console.log('');
  console.log(' ê·¸ ë‹¤ìŒ: í•˜ë‹¨ì˜ process.on("uncaughtException") ì£¼ì„ì„ í’€ê³ ');
  console.log(' /crashë¥¼ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.');
  console.log('============================================\n');
});